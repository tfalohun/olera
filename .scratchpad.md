# Olera Web Scratchpad

## Current Focus
Stabilizing and hardening the provider-facing product after building the core platform skeleton end-to-end

## In Progress
- Overlay stability validation across all browse/discover pages and roles
- Consistent minimum profile requirements enforcement across all engagement flows

## Next Up
- Validate overlay stability end-to-end across all discovery pages (caregiver, family, org roles)
- Enforce `isProfileShareable()` / `getProfileCompletionGaps()` uniformly across all discovery and engagement flows
- Verify paywall triggers correctly after free engagement limit (3 connections) is reached
- Audit remaining `transition-all` usage site-wide for other transform-related issues
- Profile detail pages: ensure click-through from discovery cards to `/profile/[id]` and `/provider/[slug]` works cleanly
- Profile switching edge cases (switching between org/caregiver/family profiles mid-session)

---

## What We Built — Platform Summary

### Product surfaces that now exist

**Public marketplace (unauthenticated)**
- Landing page with hero, featured providers, care type filters, CTAs
- Provider browse with care type / location / search filters (`/browse`)
- Public provider detail pages (`/provider/[slug]`)
- Care category navigation (Home Care, Assisted Living, Memory Care, Nursing Home, etc.)
- Marketing landing page for providers (`/for-providers`) with value props and pricing

**Auth + onboarding (overlay-based, intent-aware)**
- Auth modal (sign-in / sign-up) via Supabase email/password
- Multi-step onboarding: Intent selection (family / organization / caregiver) → Profile info → Org claim
- Form persistence across auth redirects via sessionStorage
- Deferred action system: user can trigger engagement pre-auth, complete auth, then auto-resume the action
- Auto-routing after onboarding: families → `/browse`, providers → `/portal`

**Provider portal / dashboard**
- Portal shell with sidebar navigation, auth guards, loading states (`/portal`)
- Dashboard home with stats cards, quick actions, upgrade prompts
- Profile editing: name, description, location, contact, care types (`/portal/profile`)
- Account settings with Stripe subscription management (`/portal/settings`)
- Connections management: view/accept/decline/archive by type (inquiry/invitation/application) (`/portal/connections`)
- Connection detail view (`/portal/connections/[id]`)
- Calendar view with weekly strip, day selection, appointment indicators, "Propose a Time" CTA (`/portal/calendar`)

**Role-based discovery (authenticated)**
- Providers browse families (`/portal/discover/families`, `/browse/families`)
- Organizations browse caregivers (`/portal/discover/caregivers`, `/browse/caregivers`)
- Caregivers browse organizations/jobs (`/portal/discover/providers`, `/browse/providers`)
- ConnectButton on every card: "Initiate Contact" / "Invite" / "Apply" with confirmation flow

**Profile creation + claiming**
- Create new org or caregiver profile (`/for-providers/create`)
- Search and claim existing seeded org profiles (`/for-providers/claim`, `/for-providers/claim/[slug]`)
- Profile switcher: users can own multiple profiles and switch between them

**Engagement + monetization**
- Connection system: inquiry (family→provider), invitation (org→caregiver), application (caregiver→org)
- Free tier: 3 connections, then paywall with upgrade prompt
- Pro tier: $25/mo or $249/yr — unlimited connections, full inquiry details, respond capability
- Stripe checkout integration with webhook handling
- Membership gating via `canEngage()`, `getFreeConnectionsRemaining()`, `isProfileShareable()`

### User journeys that work end-to-end (skeleton form)

1. **Family finding care:** Land → browse providers → view provider detail → sign up → onboard as family → send inquiry → view in connections
2. **Provider getting discovered:** Sign up → onboard as org → edit profile → appear in browse results → receive inquiry → view/accept in connections
3. **Provider claiming listing:** Land on `/for-providers` → search for org → claim existing profile → sign up → complete onboarding → manage from portal
4. **Caregiver finding work:** Sign up → onboard as caregiver → browse organizations → apply → view in connections
5. **Organization hiring:** Sign up → onboard as org → browse caregivers → invite → view in connections

### Known gaps and incomplete areas

- **Paywall enforcement** — free connection limit (3) is wired but needs validation that it gates correctly after limit is hit
- **Profile completeness checks** — `isProfileShareable()` exists but not uniformly enforced before engagement actions across all pages
- **Profile detail click-through** — discovery card → detail page routing needs verification for all role combinations
- **Profile switching** — switching profiles mid-session may have edge cases with stale data or incorrect role gating
- **Discovery card content** — cards show basic info but may need richer previews (certifications, pricing, availability)
- **Calendar** — skeleton with week view but no real scheduling backend; "Propose a Time" generates email template only
- **Notifications** — no notification system yet for new connections/inquiries
- **Search/filter refinement** — basic filters exist but advanced search (radius, ratings, availability) not implemented

---

## Session Log

### 2026-02-03

**Overlay stability (major debugging effort)**
- Root-caused overlay flashing/jumping across all discovery pages after 4 rounds of investigation:
  - Round 1: Changed Supabase `.single()` to `.maybeSingle()` to eliminate HTTP 406 errors (11 cards = 11x 406 storms). Removed broken Footer links (`/terms`, `/privacy`, `/pricing`, `/auth/signup`) causing Next.js prefetch 404 storms. Did not resolve flashing.
  - Round 2: Stabilized Modal useEffect via `onCloseRef` pattern — zero-dep `handleKeyDown`, effect only re-runs on `isOpen`. Added scrollbar width compensation (`paddingRight`) for scroll-lock. Did not resolve flashing.
  - Round 3: Replaced object-reference useEffect deps (`activeProfile`, `user`) with stable string IDs across all 6 browse/discover pages. Made PortalSidebar sticky. Conditional modal mounting in ConnectButton (1 active modal instead of 3 always-mounted). Bumped Modal to `z-[60]`. Added `forwards` animation fill-mode. Did not resolve flashing.
  - **Round 4 (true root cause):** CSS `transform` on card hover (`hover:-translate-y-0.5`) creates a new containing block per the CSS spec, breaking `position: fixed` on Modal descendants. This was the architectural issue.
- Implemented two-pronged fix:
  1. Portaled Modal to `document.body` via `createPortal` — fixed positioning now always references viewport
  2. Removed `hover:-translate-y-0.5` and `transition-all` from all 7 card components, replaced with `transition-shadow`

**ConnectButton rewrite**
- Replaced 3 independent boolean modal states with discriminated union `ModalState` (`closed | confirm | success | upgrade | incomplete`)
- Added local optimistic counter for immediate paywall gating
- Awaited `refreshAccountData()` after connection creation

**Navbar cleanup**
- Removed care category dropdowns for all authenticated users (family, caregiver, org)
- Authenticated navbar: logo left + avatar dropdown right only
- Categories remain for unauthenticated visitors browsing the public marketplace

**Calendar page rewrite**
- Visual weekly calendar strip with Mon-Sun day cells
- Week navigation with prev/next arrows, "Back to today"
- Day selection with dot indicators for days with appointments
- "Propose a Time" as primary CTA on appointment cards
- Compact and full card variants
- "All Connections" list below calendar

### 2026-02-02
- Started Vercel setup process
- Created scratchpad to track progress
- Created `feature/vercel-setup` branch

## Decisions Made
- Using Vercel for deployment (hosting platform choice)
- **Three actor types:** family, organization (provider), caregiver — each with distinct browse/discover experiences and connection types
- **Connection model:** inquiry (family→provider), invitation (org→caregiver), application (caregiver→org), save — with pending/accepted/declined/archived statuses
- **Freemium monetization:** 3 free connections for providers, then hard paywall. Families always free. Pro at $25/mo or $249/yr.
- **Auth is overlay-based:** modal sign-in/sign-up, not full-page routes. Intent-aware: deferred actions resume after auth completes.
- **Onboarding is multi-step:** intent → profile info → optional org claim. Auto-routes by role after completion.
- **Modal portaling via `createPortal(document.body)`** — required for any `position: fixed` component that may render inside transformed ancestors. CSS spec constraint.
- **No CSS `transform` on card ancestors containing modals.** Shadow-only hover effects (`transition-shadow`) instead.
- **Authenticated navbar is minimal.** Portal sidebar provides navigation once logged in.
- **ConnectButton uses discriminated union state machine** to prevent impossible states.
- **useEffect deps use stable string IDs** (not object references) to prevent re-fetch cascades.

## Notes
- **Stack:** Next.js 16 App Router, React 19, TypeScript, Tailwind CSS, Supabase (auth + database), Stripe (billing)
- **Supabase schema:** accounts, profiles, memberships, connections tables. Profile metadata stored as JSONB per type.
- **CSS containing block rule:** `transform`, `filter`, and `will-change` on ancestors all break `position: fixed` for descendants. Always use `createPortal` for modals/overlays that may be nested inside interactive components.
- **`transition-all` is dangerous** — it transitions `transform`, `opacity`, `filter` which all create containing blocks or stacking contexts. Always prefer specific transition properties.
- **Supabase `.single()` vs `.maybeSingle()`:** `.single()` returns HTTP 406 on zero rows. Always use `.maybeSingle()` for queries that may return no results.
- All secondary fixes from the overlay debugging (stable deps, ref patterns, scroll compensation, conditional mounting, z-index, sidebar stickiness) were real improvements addressing legitimate bugs, even though the primary cause was the CSS transform issue.
